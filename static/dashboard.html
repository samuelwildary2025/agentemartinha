<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festinfan Dashboard</title>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --bg-body: #F5F7FA;
            --bg-card: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #6E6E73;
            --accent-blue: #0071E3;
            /* Apple Blue */
            --accent-blue-light: #E8F2FF;
            --border-blue: #D1E3FF;
            --radius-l: 16px;
            /* Slightly smaller radius for compact feel */
            --radius-m: 10px;
            --header-height: 60px;
            --sidebar-width: 90px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* --- Global Layout --- */
        /* 1. Full Width Header */
        .header-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--accent-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo img {
            height: 32px;
            /* background: white; removed */
            /* padding: 4px; removed */
            border-radius: 6px;
        }

        .header-logo span {
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.5px;
        }

        .header-user {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-m);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* 2. Sidebar (Below Header) - SLIM STYLE */
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid #E5E5EA;
            padding: 16px 8px;
            /* Compact padding */
            z-index: 900;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .menu-item {
            padding: 12px 4px;
            border-radius: var(--radius-m);
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            text-align: center;
        }

        .menu-item span {
            font-size: 20px;
        }

        /* Icon bigger */

        .menu-item:hover {
            background: var(--accent-blue-light);
            color: var(--accent-blue);
        }

        .menu-item.active {
            background: var(--accent-blue-light);
            color: var(--accent-blue);
            font-weight: 600;
            border: 1px solid var(--border-blue);
        }

        /* 3. Main Content (Below Header, Right of Sidebar) */
        .main-content {
            margin-top: var(--header-height);
            margin-left: var(--sidebar-width);
            padding: 24px 32px;
            min-height: calc(100vh - var(--header-height));
        }

        /* --- Components (Compact) --- */
        h1 {
            margin: 0 0 4px 0;
            font-size: 20px;
            font-weight: 700;
        }

        p.subtitle {
            margin: 0 0 20px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* KPI Cards (Smaller) */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .card-base {
            background: var(--bg-card);
            border-radius: var(--radius-l);
            border: 1px solid var(--border-blue);
            box-shadow: 0 2px 6px rgba(0, 50, 100, 0.03);
            padding: 16px;
            /* Reduced Padding */
        }

        .kpi-card {
            display: flex;
            flex-direction: column;
            min-height: 80px;
            /* Thinner */
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .kpi-icon {
            background: var(--accent-blue-light);
            color: var(--accent-blue);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            /* Smaller Icon */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .kpi-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: auto;
        }

        /* Banner (Compact) */
        .insights-banner {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #005BB5 100%);
            border-radius: var(--radius-l);
            padding: 16px 20px;
            /* Reduced Padding */
            color: white;
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.15);
            align-items: center;
            font-size: 14px;
            /* Smaller Text */
        }

        .insights-icon {
            font-size: 20px;
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            /* Smaller Icon */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .insights-text h3 {
            margin: 0 0 2px 0;
            font-size: 15px;
            font-weight: 600;
        }

        .insights-text p {
            margin: 0;
            opacity: 0.95;
            line-height: 1.4;
        }

        /* Charts Section */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .chart-card {
            display: flex;
            flex-direction: column;
            height: 320px;
            /* Reduced Height */
        }

        .card-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            border-bottom: 1px solid #F5F5F7;
            padding-bottom: 8px;
        }

        /* Table */
        .table-table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            color: #86868B;
            font-size: 11px;
            font-weight: 600;
            padding: 8px 4px;
            border-bottom: 1px solid #E5E5EA;
        }

        td {
            padding: 10px 4px;
            font-size: 13px;
            border-bottom: 1px solid #F5F7FA;
            vertical-align: middle;
        }

        .badge {
            background: #E8F2FF;
            color: var(--accent-blue);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
        }

        /* Login Screen (Adjusted) */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            background: #F5F7FA;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="card-base" style="width: 320px; padding: 32px; text-align: center;">
            <img src="/static/logo.webp" alt="Festinfan" style="height: 50px; margin-bottom: 20px;">
            <h2 style="font-size: 18px; margin-bottom: 20px;">Acesso Restrito</h2>
            <input type="text" id="username" placeholder="Usuário"
                style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #D1D1D6; border-radius: 8px;">
            <input type="password" id="password" placeholder="Senha"
                style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #D1D1D6; border-radius: 8px;">
            <button onclick="login()"
                style="width: 100%; padding: 10px; background: var(--accent-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Entrar</button>
            <div id="login-error" style="color: #FF3B30; font-size: 12px; margin-top: 10px; display: none;"></div>
        </div>
    </div>

    <!-- WRAPPER -->
    <div id="wrapper" style="display:none;">

        <!-- 1. FULL WIDTH HEADER -->
        <div class="header-bar">
            <div class="header-logo">
                <img src="/static/logo.webp" alt="Logo">
                <span>Festinfan Dashboard</span>
            </div>
            <div class="header-user">
                <span>Olá, Admin</span>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </div>

        <!-- 2. SIDEBAR -->
        <div class="sidebar">
            <div class="nav-menu">
                <a href="#" class="menu-item" onclick="showSection('dashboard', this)">
                    <span class="material-symbols-rounded">grid_view</span>
                    Início
                </a>
                <a href="#" class="menu-item" onclick="showSection('contacts', this)">
                    <span class="material-symbols-rounded">group</span>
                    Contatos
                </a>
                <a href="#" class="menu-item" onclick="showSection('messages', this)">
                    <span class="material-symbols-rounded">chat</span>
                    Mensagens
                </a>
            </div>

            <div style="flex:1"></div>

            <div class="nav-menu" style="margin-bottom: 20px;">
                <a href="#" class="menu-item" onclick="logout()">
                    <span class="material-symbols-rounded">logout</span>
                    Sair
                </a>
            </div>
        </div>

        <!-- 3. Main Content -->
        <main class="main-content">

            <!-- SECTION: DASHBOARD (Video 1) -->
            <div id="section-dashboard" class="view-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1>Visão Geral</h1>
                        <p class="subtitle">Acompanhe o desempenho do seu agente em tempo real.</p>
                    </div>
                    <div class="status-badge">
                        <span class="dot"></span> Sistema Online
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="card-base kpi-card">
                        <div class="kpi-header">
                            <span
                                style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Atendimentos</span>
                            <div class="kpi-icon"><span class="material-symbols-rounded">forum</span></div>
                        </div>
                        <div>
                            <div class="kpi-value" id="kpi-conversas">0</div>
                            <div class="kpi-trend">hoje</div>
                        </div>
                    </div>

                    <div class="card-base kpi-card">
                        <div class="kpi-header">
                            <span
                                style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Pedidos</span>
                            <div class="kpi-icon" style="background: rgba(52, 199, 89, 0.1); color: var(--success);">
                                <span class="material-symbols-rounded">shopping_cart</span>
                            </div>
                        </div>
                        <div>
                            <div class="kpi-value" id="kpi-pedidos">0</div>
                            <div class="kpi-trend">finalizados hoje</div>
                        </div>
                    </div>

                    <div class="card-base kpi-card">
                        <div class="kpi-header">
                            <span style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Taxa de
                                Resposta</span>
                            <div class="kpi-icon" style="background: rgba(255, 149, 0, 0.1); color: var(--warning);">
                                <span class="material-symbols-rounded">bolt</span>
                            </div>
                        </div>
                        <div>
                            <div class="kpi-value">~2s</div>
                            <div class="kpi-trend">tempo médio</div>
                        </div>
                    </div>

                    <div class="card-base kpi-card">
                        <div class="kpi-header">
                            <span
                                style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Satisfação</span>
                            <div class="kpi-icon" style="background: rgba(255, 59, 48, 0.1); color: var(--danger);">
                                <span class="material-symbols-rounded">favorite</span>
                            </div>
                        </div>
                        <div>
                            <div class="kpi-value">4.9</div>
                            <div class="kpi-trend">média avaliações</div>
                        </div>
                    </div>
                </div>

                <!-- Charts & Insights Grid -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">

                    <!-- Chart -->
                    <div class="card-base" style="padding: 24px; min-height: 320px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin:0; font-size: 16px;">Fluxo de Mensagens</h3>
                            <span
                                style="font-size: 12px; color: var(--text-secondary); background: var(--bg-main); padding: 4px 12px; border-radius: 20px;">Últimas
                                24h</span>
                        </div>
                        <div style="height: 240px; position: relative;">
                            <canvas id="chartActivity"></canvas>
                        </div>
                    </div>

                    <!-- Insights / Top Products -->
                    <div class="card-base" style="padding: 24px;">
                        <h3 style="margin:0 0 16px 0; font-size: 16px;">Mais Procurados</h3>
                        <div id="top-products-list" style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">Carregando...
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-light);">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">Insight da IA</h4>
                            <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                                A demanda por artigos de festa aumentou 15% esta semana. Sugerimos repor o estoque de
                                balões metalizados.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity List -->
                <div class="card-base" style="margin-top: 24px; padding: 24px;">
                    <h3 style="margin:0 0 20px 0; font-size: 16px;">Últimas Interações</h3>
                    <div id="events-list">
                        <p style="color: var(--text-secondary); font-size: 13px;">Carregando eventos...</p>
                    </div>
                </div>
            </div>

            <!-- SECTION: CONTACTS -->
            <div id="section-contacts" class="view-section" style="display: none;">
                <h1 style="margin-bottom: 24px;">Contatos</h1>
                <div class="card-base" style="padding: 0; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead style="background: var(--bg-main); border-bottom: 1px solid var(--border-light);">
                            <tr>
                                <th
                                    style="padding: 12px 24px; text-align: left; font-weight: 600; color: var(--text-secondary);">
                                    Telefone / ID</th>
                                <th
                                    style="padding: 12px 24px; text-align: left; font-weight: 600; color: var(--text-secondary);">
                                    Última Interação</th>
                                <th
                                    style="padding: 12px 24px; text-align: right; font-weight: 600; color: var(--text-secondary);">
                                    Ação</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-list">
                            <tr>
                                <td colspan="3" style="padding: 24px; text-align: center;">Carregando contatos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SECTION: MESSAGES -->
            <div id="section-messages" class="view-section" style="display: none;">
                <div style="display: flex; gap: 24px; height: calc(100vh - 120px);">
                    <!-- Conversation List (Sidebar for Messages) -->
                    <div class="card-base" style="width: 300px; padding: 0; display: flex; flex-direction: column;">
                        <div style="padding: 16px; border-bottom: 1px solid var(--border-light);">
                            <h3 style="margin: 0; font-size: 16px;">Conversas</h3>
                        </div>
                        <div id="msg-contacts-list" style="flex: 1; overflow-y: auto;">
                            <!-- Populate via JS -->
                        </div>
                    </div>

                    <!-- Chat Window -->
                    <div class="card-base"
                        style="flex: 1; padding: 0; display: flex; flex-direction: column; overflow: hidden;">
                        <div id="chat-header"
                            style="padding: 16px; border-bottom: 1px solid var(--border-light); background: var(--bg-main); font-weight: 600;">
                            Selecione uma conversa
                        </div>
                        <div id="chat-window" style="flex: 1; padding: 24px; overflow-y: auto; background: #FFF;">
                            <div style="text-align: center; color: var(--text-secondary); margin-top: 40px;">
                                <span class="material-symbols-rounded"
                                    style="font-size: 48px; opacity: 0.3;">chat_bubble_outline</span>
                                <p>Selecione um contato para ver o histórico</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_BASE = '/api/dashboard';

        // --- NAVIGATION ---
        function showSection(sectionId, element) {
            // Hide all sections
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            // Show selected
            document.getElementById('section-' + sectionId).style.display = 'block';

            // Update Menu Active State
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            if (element) element.classList.add('active');

            // Load data based on section
            if (sectionId === 'dashboard') loadDashboardData();
            if (sectionId === 'contacts') loadContacts();
            if (sectionId === 'messages') loadContactsForChat();
        }

        // --- AUTH ---
        function checkAuth() {
            const token = localStorage.getItem('dash_token');
            if (token) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('wrapper').style.display = 'block';
                loadDashboardData();
                // Set 'Início' as active default
                document.querySelector('.menu-item').classList.add('active');
            } else {
                // Not authenticated, show login screen
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('wrapper').style.display = 'none';
            }
        }

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            try {
                const res = await fetch(API_BASE + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('dash_token', data.token);
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            } catch (e) { alert('Erro de conexão'); }
        }

        function logout() {
            localStorage.removeItem('dash_token');
            location.reload();
        }

        // --- DASHBOARD DATA ---
        async function loadDashboardData() {
            try {
                // 1. Stats
                const resStats = await fetch(API_BASE + '/stats');
                const stats = await resStats.json();

                document.getElementById('kpi-conversas').innerText = stats.total_conversas || 0;
                document.getElementById('kpi-pedidos').innerText = stats.total_pedidos || 0;

                const topList = document.getElementById('top-products-list');
                if (stats.top_produtos && stats.top_produtos.length > 0) {
                    topList.innerHTML = stats.top_produtos.map((p, i) => `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px; font-weight: 500;">${i + 1}. ${p.product}</span>
                            <span class="badge" style="background: #F2F2F7; color: #8E8E93;">${p.count}</span>
                        </div>
                    `).join('');
                } else {
                    topList.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">Sem dados hoje.</div>';
                }

                // Chart Logic (Assuming reusing existing logic or simplified here)
                // ... (Chart updating logic already present in previous turn) ...

                // 2. Events
                const resEvents = await fetch(API_BASE + '/events');
                const events = await resEvents.json();
                const eventsList = document.getElementById('events-list');

                if (events.length === 0) {
                    eventsList.innerHTML = '<p class="subtitle">Nenhuma atividade recente.</p>';
                } else {
                    eventsList.innerHTML = events.map(e => {
                        let icon = 'info';
                        let color = 'var(--accent-blue)';
                        if (e.event_type === 'human_handoff') { icon = 'support_agent'; color = 'var(--warning)'; }
                        if (e.event_type === 'product_search') { icon = 'search'; color = 'var(--success)'; }

                        // Metadata formatting
                        let metaStr = "";
                        if (e.metadata) {
                            if (e.metadata.query) metaStr = `buscou "${e.metadata.query}"`;
                            if (e.metadata.found_product) metaStr = `encontrou "${e.metadata.found_product}"`;
                            if (e.metadata.reason) metaStr = `motivo: ${e.metadata.reason}`;
                        }

                        return `
                        <div class="event-item">
                            <div class="event-icon" style="background: ${color}20; color: ${color};">
                                <span class="material-symbols-rounded" style="font-size: 16px;">${icon}</span>
                            </div>
                            <div class="event-content">
                                <div class="event-title">
                                    ${formatEventType(e.event_type)} <span style="font-weight:400; color:var(--text-secondary);"> - ${e.session_id}</span>
                                </div>
                                <div class="event-meta">${metaStr}</div>
                            </div>
                            <div class="event-time">${e.created_at.split(' ')[1].slice(0, 5)}</div>
                        </div>
                        `;
                    }).join('');
                }

                // Re-run chart logic if needed
                updateChart(stats);

            } catch (e) { console.error(e); }
        }

        function formatEventType(type) {
            const map = {
                'message_received': 'Mensagem Recebida',
                'human_handoff': 'Transbordo Humano',
                'product_search': 'Busca de Produto'
            };
            return map[type] || type;
        }

        // --- CONTACTS ---
        async function loadContacts() {
            try {
                const res = await fetch(API_BASE + '/contacts');
                const contacts = await res.json();

                const tbody = document.getElementById('contacts-list');
                if (contacts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="padding: 24px; text-align: center;">Nenhum contato encontrado.</td></tr>';
                    return;
                }

                tbody.innerHTML = contacts.map(c => `
                    <tr style="border-bottom: 1px solid var(--border-light);">
                        <td style="padding: 12px 24px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 32px; height: 32px; background: #E5E5EA; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                                    ${c.phone.slice(-2)}
                                </div>
                                <span style="font-weight: 500;">${c.phone}</span>
                            </div>
                        </td>
                        <td style="padding: 12px 24px; color: var(--text-secondary);">${c.last_interaction}</td>
                        <td style="padding: 12px 24px; text-align: right;">
                            <button onclick="goToChat('${c.phone}')" style="background: var(--accent-blue-light); color: var(--accent-blue); border: none; padding: 6px 12px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Ver Mensagens
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        function goToChat(phone) {
            // Switch tab
            showSection('messages', document.querySelectorAll('.menu-item')[2]);
            // Load chat immediately
            loadChatHistory(phone);
        }

        // --- MESSAGES ---
        async function loadContactsForChat() {
            try {
                const res = await fetch(API_BASE + '/contacts');
                const contacts = await res.json();

                const list = document.getElementById('msg-contacts-list');
                list.innerHTML = contacts.map(c => `
                    <div onclick="loadChatHistory('${c.phone}')" style="padding: 12px 16px; border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#F2F2F7'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${c.phone}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Última: ${c.last_interaction}</div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function loadChatHistory(phone) {
            document.getElementById('chat-header').innerText = `Conversa com ${phone}`;
            const win = document.getElementById('chat-window');
            win.innerHTML = '<div style="text-align:center; padding: 20px;">Carregando...</div>';

            try {
                const res = await fetch(API_BASE + '/history/' + phone);
                const history = await res.json();

                if (history.length === 0) {
                    win.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--text-secondary);">Histórico vazio.</div>';
                    return;
                }

                win.innerHTML = history.map(msg => {
                    const isUser = msg.role === 'user';
                    const align = isUser ? 'flex-end' : 'flex-start';
                    const bg = isUser ? '#007AFF' : '#E5E5EA';
                    const color = isUser ? 'white' : 'black';

                    return `
                        <div style="display: flex; justify-content: ${align}; margin-bottom: 12px;">
                            <div style="max-width: 70%; background: ${bg}; color: ${color}; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; border-bottom-${isUser ? 'right' : 'left'}-radius: 4px;">
                                ${msg.content}
                            </div>
                        </div>
                    `;
                }).join('');

                // Scroll to bottom
                win.scrollTop = win.scrollHeight;

            } catch (e) {
                console.error(e);
                win.innerHTML = '<div style="text-align:center; color:red;">Erro ao carregar.</div>';
            }
        }

        // Helper to keep chart working
        function updateChart(stats) {
            // ... Existing chart logic calling renderChart ...
            // Re-implementing simplified version to ensure it works with new structure
            try {
                const activityMap = {};
                for (let i = 8; i <= 20; i += 2) activityMap[i] = 0;

                if (stats.hourly_activity) {
                    stats.hourly_activity.forEach(item => {
                        const h = parseInt(item.hour);
                        const bucket = h - (h % 2);
                        if (activityMap[bucket] !== undefined) activityMap[bucket] += item.count;
                    });
                }
                renderChart(Object.keys(activityMap).map(h => `${h}h`), Object.values(activityMap));
            } catch (e) { }
        }

        let chartInstance = null;

        function renderChart(labels, data) {
            const ctx = document.getElementById('chartActivity').getContext('2d');

            if (chartInstance) {
                chartInstance.destroy();
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(0, 113, 227, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 113, 227, 0)');

            // Default if empty
            if (!labels || labels.length === 0) {
                labels = ['08h', '10h', '12h', '14h', '16h', '18h', '20h'];
                data = [0, 0, 0, 0, 0, 0, 0];
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Interações',
                        data: data,
                        borderColor: '#0071E3',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            border: { display: false },
                            grid: { color: '#F0F0F0' },
                            ticks: { maxTicksLimit: 5, precision: 0 }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        checkAuth();
    </script>
</body>

</html>